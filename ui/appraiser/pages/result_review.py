# ui/appraiser/pages/result_review.py
"""
RESULT REVIEW ‚Äì APPRAISER
========================

üö´ GOVERNANCE LOCK ‚Äì STRICT COMPLIANCE
Tu√¢n th·ªß tuy·ªát ƒë·ªëi:
- MASTER_SPEC.md
- IMPLEMENTATION STATUS ‚Äì PART 1 & PART 2

üéØ M·ª§C ƒê√çCH
- Cho ph√©p Appraiser REVIEW k·∫øt qu·∫£ valuation ƒë√£ sinh
- Hi·ªÉn th·ªã:
    ‚úî Indicative price
    ‚úî Confidence (m√¥ t·∫£)
    ‚úî Model breakdown
    ‚úî Risk / warning
- READ-ONLY tuy·ªát ƒë·ªëi
- KH√îNG approval
- KH√îNG override t·∫°i ƒë√¢y

üìå NGUY√äN T·∫ÆC B·∫§T BI·∫æN
- Result = t√≠n hi·ªáu tham kh·∫£o
- UI kh√¥ng di·ªÖn gi·∫£i gi√° ‚Äúƒë√∫ng / sai‚Äù
- Human judgment n·∫±m ngo√†i UI
"""

import streamlit as st
from typing import Dict, Any

from ui.shared.auth.role_guard import require_role
from ui.shared.state.role_state import Role
from ui.shared.state.session_state import get_selected_valuation_id
from ui.shared.api_client.valuation_api import get_dossier
from ui.shared.components.disclaimer_box import render_disclaimer
from ui.shared.components.confidence_gauge import render_confidence_gauge
from ui.shared.components.risk_indicator import render_risk_indicator
from ui.shared.components.model_status import render_model_status
from ui.shared.components.model_status_explainer import render_model_status_explainer
from ui.shared.components.table import render_table
from ui.shared.utils.format_price import format_price
from ui.shared.utils.safe_render import safe_markdown


# =========================
# PAGE ENTRY
# =========================

def render_result_review() -> None:
    """
    Render valuation result review page for Appraiser.
    """

    # =========================
    # ROLE GUARD
    # =========================
    if not require_role(
        [Role.APPRAISER],
        message="Only Appraisers are allowed to review valuation results.",
    ):
        return

    st.title("üìä Valuation Result Review")

    render_disclaimer(
        title="Governance Notice",
        message=(
            "The results displayed below are indicative signals generated by "
            "the valuation system. They do not represent a final valuation, "
            "approval, or legally binding conclusion."
        ),
        level="warning",
    )

    # =========================
    # LOAD CONTEXT
    # =========================
    valuation_id = get_selected_valuation_id()

    if not valuation_id:
        st.info("No valuation selected. Please submit or select a valuation first.")
        return

    # =========================
    # FETCH DOSSIER
    # =========================
    with st.spinner("Loading valuation results‚Ä¶"):
        dossier: Dict[str, Any] = get_dossier(valuation_id)

    if not dossier:
        st.error("Unable to load valuation dossier.")
        return

    valuation_output: Dict[str, Any] = dossier.get("valuation_output", {})
    ensemble_output: Dict[str, Any] = valuation_output.get("ensemble", {})
    confidence_output: Dict[str, Any] = valuation_output.get("confidence", {})
    risk_output: Dict[str, Any] = valuation_output.get("risk", {})
    model_outputs: Dict[str, Any] = valuation_output.get("models", {})

    # =========================
    # INDICATIVE PRICE
    # =========================
    st.subheader("üí∞ Indicative Price (Reference Only)")

    indicative_price = ensemble_output.get("price")

    if indicative_price is None:
        st.warning("No indicative price available.")
    else:
        st.metric(
            label="Indicative Valuation",
            value=format_price(indicative_price),
        )

    # =========================
    # CONFIDENCE
    # =========================
    st.subheader("üìà Confidence (Descriptive)")

    render_confidence_gauge(confidence_output)

    # =========================
    # RISK INDICATOR
    # =========================
    st.subheader("‚ö†Ô∏è Risk Indicators")

    render_risk_indicator(risk_output)

    # =========================
    # MODEL STATUS OVERVIEW
    # =========================
    st.subheader("üß† Model Participation Status")

    model_rows = []

    for model_name, model_info in model_outputs.items():
        status = model_info.get("status")
        model_rows.append(
            {
                "Model": model_name,
                "Status": render_model_status(status, inline=True),
            }
        )

    if model_rows:
        render_table(model_rows)
    else:
        st.info("No model-level details available.")

    render_model_status_explainer()

    # =========================
    # FOOTNOTE
    # =========================
    safe_markdown(
        """
---
### Legal & Professional Reminder
- The indicative price is **not** a market value conclusion.
- Confidence reflects **model agreement & data quality**, not correctness.
- Any discrepancy or concern must be handled through:
  **Human review and formal override workflow**.

üìå *Result review ‚â† Acceptance ‚â† Approval*
        """
    )


"""
üìå AUDIT & LEGAL NOTES
---------------------
- Result review UI ph·ª•c v·ª• minh b·∫°ch & ki·ªÉm so√°t r·ªßi ro
- Kh√¥ng c√≥ h√†nh ƒë·ªông nghi·ªáp v·ª• t·∫°i ƒë√¢y
- Kh√¥ng ghi nh·∫≠n quy·∫øt ƒë·ªãnh con ng∆∞·ªùi

Nguy√™n t·∫Øc:
"AI presents signals. Humans remain accountable."
"""
