# ui/appraiser/components/warning_panel.py
"""
WARNING PANEL ‚Äì APPRAISER VIEW
==============================

üö´ GOVERNANCE LOCK ‚Äì STRICT COMPLIANCE
Tu√¢n th·ªß tuy·ªát ƒë·ªëi:
- MASTER_SPEC.md
- IMPLEMENTATION STATUS ‚Äì PART 1 & PART 2

üìå M·ª§C ƒê√çCH
- Hi·ªÉn th·ªã c√°c c·∫£nh b√°o (warnings / flags) do h·ªá th·ªëng sinh ra
- H·ªó tr·ª£ th·∫©m ƒë·ªãnh vi√™n:
    ‚úî nh·∫≠n bi·∫øt r·ªßi ro
    ‚úî ch√∫ √Ω c√°c ƒëi·ªÉm b·∫•t th∆∞·ªùng
    ‚úî ph·ª•c v·ª• gi·∫£i tr√¨nh & audit

üìå NGUY√äN T·∫ÆC B·∫§T BI·∫æN
- READ-ONLY tuy·ªát ƒë·ªëi
- KH√îNG:
    ‚ùå suy di·ªÖn m·ª©c ƒë·ªô nghi√™m tr·ªçng m·ªõi
    ‚ùå g·ªôp / xo√° c·∫£nh b√°o
    ‚ùå quy·∫øt ƒë·ªãnh ph√™ duy·ªát hay t·ª´ ch·ªëi

üìå Warning = t√≠n hi·ªáu ki·ªÉm so√°t, KH√îNG ph·∫£i k·∫øt lu·∫≠n
"""

import streamlit as st
from typing import List, Dict, Any

from ui.shared.auth.role_guard import require_role
from ui.shared.state.role_state import Role
from ui.shared.components.disclaimer_box import render_disclaimer
from ui.shared.utils.safe_render import safe_markdown


# =========================
# MAIN RENDER
# =========================

def render_warning_panel(
    warnings: List[Dict[str, Any]],
) -> None:
    """
    Render panel c·∫£nh b√°o.

    Parameters
    ----------
    warnings : List[Dict[str, Any]]
        V√≠ d·ª•:
        [
            {
                "code": "LOW_DATA_COVERAGE",
                "level": "HIGH",
                "message": "Comparable data coverage is below minimum threshold.",
                "source": "Data Quality Engine"
            },
            {
                "code": "MODEL_DISPERSION",
                "level": "MEDIUM",
                "message": "High dispersion detected across core models.",
                "source": "Ensemble Monitor"
            }
        ]

    GOVERNANCE
    ----------
    - Warnings ph·∫£i ƒë·∫øn t·ª´ valuation_dossier
    - UI kh√¥ng ƒë∆∞·ª£c t·∫°o hay ch·ªânh s·ª≠a c·∫£nh b√°o
    """

    # =========================
    # ROLE GUARD
    # =========================
    if not require_role(
        [Role.APPRAISER, Role.MANAGER, Role.AUDITOR],
        message="Warning panel is restricted to appraisal roles.",
    ):
        return

    st.subheader("‚ö†Ô∏è System Warnings & Flags")

    render_disclaimer(
        title="Governance Notice",
        message=(
            "Warnings shown below are generated by governed system checks. "
            "They indicate potential risks or limitations and MUST be reviewed "
            "by a qualified human appraiser."
        ),
        level="warning",
    )

    if not warnings:
        st.success("No system warnings detected.")
        return

    # =========================
    # RENDER WARNINGS
    # =========================
    for warning in warnings:
        level = warning.get("level", "INFO").upper()
        code = warning.get("code", "UNKNOWN")
        message = warning.get("message", "")
        source = warning.get("source", "System")

        header = f"[{level}] {code}"
        body = f"{message}\n\n_Source: {source}_"

        if level == "HIGH":
            st.error(f"‚ùó {header}\n\n{body}")
        elif level == "MEDIUM":
            st.warning(f"‚ö†Ô∏è {header}\n\n{body}")
        else:
            st.info(f"‚ÑπÔ∏è {header}\n\n{body}")

    # =========================
    # AUDIT FOOTNOTE
    # =========================
    safe_markdown(
        """
**Audit Notes**
- Warnings are *signals*, not decisions.
- Presence of warnings does NOT invalidate valuation automatically.
- All warnings must be acknowledged during human review.

_No warning is ignored. No warning decides alone._
        """
    )


"""
üìå AUDIT & LEGAL NOTES
---------------------
- Warning Panel:
    ‚úî B·∫Øt bu·ªôc cho ki·ªÉm so√°t r·ªßi ro
    ‚úî Ph·ª•c v·ª• credit review & audit trail
    ‚úî Minh b·∫°ch ho√° gi·ªõi h·∫°n h·ªá th·ªëng

Nguy√™n t·∫Øc b·∫•t bi·∫øn:
"C·∫£nh b√°o ƒë·ªÉ con ng∆∞·ªùi quy·∫øt ‚Äì kh√¥ng ƒë·ªÉ AI quy·∫øt."

AI ph√°t hi·ªán r·ªßi ro.  
Con ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám x·ª≠ l√Ω.
"""
